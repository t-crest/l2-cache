name: TACLe Benchmark Test

on:
  push:
    branches:
      - "*"
  pull_request:
    branches:
      - "*"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Install prerequisites
        run: sudo apt install git openjdk-11-jdk cmake make g++ texinfo flex bison subversion libelf-dev graphviz libboost-dev libboost-program-options-dev ruby-full chrpath liblpsolve55-dev zlib1g-dev gtkwave gtkterm scala autoconf libfl2 expect verilator curl

      - name: Setup Scala
        uses: olafurpg/setup-scala@v14

      - name: Checkout L2 cache
        uses: actions/checkout@v3
        with:
          path: t-crest/l2-cache

      - name: Checkout patmos-misc
        uses: actions/checkout@v3
        with:
          repository: t-crest/patmos-misc
          path: t-crest/misc

      - name: Add path
        working-directory: t-crest/
        run: echo "$PWD/local/bin" >> $GITHUB_PATH

      - name: Setup tools
        working-directory: t-crest/
        run: ./misc/build.sh -q

      - name: Verify patmos-clang
        run: patmos-clang --version

      - name: Verify emulator
        run: patemu -h

      # Checkout TACLe benchmarks
      - name: Checkout TACLe benchmark repository
        uses: actions/checkout@v3
        with:
          repository: tacle/tacle-bench
          path: t-crest/tacle

        # Build patmos emulator
        # TODO: Better add an l2 config file in patmos
#      - name: Build patmos emulator
#        working-directory: ./patmos
#        run: |
#          mkdir -p local/bin
#          cd hardware/config/
#          sed -i '17i\<L2Cache size="64k" ways="8" bytesPerBlock="64" repl="plru" />' altde2-115.xml
#          sed -i '10s/.*/<!-- -->/' altde2-115.xml
#          cd ../..
#          make emulator
#
#      - name: Verify patmos emulator
#        working-directory: ./tacle
#        run: ../local/patemu -h

      - name: Run tacle benchmarks
        working-directory: t-crest/tacle/bench
        run: |
          COMPILER=patmos-clang
          OPTIONS=" -Wall -Wno-unknown-pragmas -Werror -O2"
          EXEC=pasim
          PASS=0
          FAIL_COMP=0
          FAIL_EXEC=0

          for dir in */ ; do
              # Skip the 'parallel' directory entirely
              [[ "$dir" == "parallel/" ]] && continue

              printf "Entering ${dir}\n"
              cd "$dir"

              for BENCH in */ ; do
                  # Skip certain subdirectories
                  case "$dir$BENCH" in
                      "kernel/pm/"| \
                      "kernel/isqrt/"| \
                      "kernel/fft/"| \
                      "sequential/rijndael_dec/"| \
                      "sequential/rijndael_enc/")
                          echo "Skipping ${dir}${BENCH}"
                          continue
                          ;;
                  esac

                  printf "Checking ${dir}${BENCH}\n"
                  cd "$BENCH"

                  if [ -f a.out ]; then
                      rm a.out
                  fi

                  if [ -f *.o ]; then
                      rm *.o
                  fi

                  cd ..
              done

              printf "Leaving ${dir}\n\n"
              cd ..
          done